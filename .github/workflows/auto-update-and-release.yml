name: Auto Update and Release

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9 ç‚¹æ£€æŸ¥æ›´æ–° (UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/louislam/uptime-kuma.git || true
          git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          # èŽ·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
          UPSTREAM_VERSION=$(git describe --tags --abbrev=0 upstream/master 2>/dev/null || echo "0.0.0")
          # èŽ·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")

          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_VERSION" != "$CURRENT_VERSION" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ‰ å‘çŽ°æ–°ç‰ˆæœ¬: $CURRENT_VERSION -> $UPSTREAM_VERSION"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: $CURRENT_VERSION"
          fi

      - name: Merge upstream changes
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          # åˆå¹¶ä¸Šæ¸¸æ›´æ–°
          git merge upstream/master --no-edit || {
            echo "âš ï¸ åˆå¹¶å†²çªï¼Œå°è¯•ä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬"
            git merge --strategy-option theirs upstream/master --no-edit
          }

      - name: Setup Node.js
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install production dependencies only
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "ðŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆèŠ‚çœèµ„æºï¼‰"
          npm ci --omit=dev --no-audit --prefer-offline

      - name: Download pre-built frontend
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "â¬‡ï¸ ä¸‹è½½é¢„æž„å»ºå‰ç«¯èµ„æº"
          npm run download-dist || {
            echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æœ¬åœ°æž„å»º"
            npm install --include=dev
            npm run build
          }

      - name: Create optimized deployment package
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "ðŸ“¦ åˆ›å»ºä¼˜åŒ–éƒ¨ç½²åŒ…"

          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p deploy-package

          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp -r server deploy-package/
          cp -r dist deploy-package/
          cp -r db deploy-package/
          cp -r extra deploy-package/
          cp -r node_modules deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/

          # åˆ›å»ºä¼˜åŒ–çš„å¯åŠ¨è„šæœ¬
          cat > deploy-package/start-optimized.sh << 'EOF'
#!/bin/bash
# Uptime Kuma ä¼˜åŒ–å¯åŠ¨è„šæœ¬ - é€‚ç”¨äºŽä½Žé…æœåŠ¡å™¨

# é™åˆ¶ Node.js å†…å­˜ä½¿ç”¨ (128MB)
export NODE_OPTIONS="--max-old-space-size=128"

# è®¾ç½®ç”Ÿäº§çŽ¯å¢ƒ
export NODE_ENV=production

# å‡å°‘æ—¥å¿—è¾“å‡º
export UPTIME_KUMA_LOG_LEVEL=warn

# å¯åŠ¨æœåŠ¡
node server/server.js
EOF

          chmod +x deploy-package/start-optimized.sh

          # åˆ›å»º PM2 é…ç½®æ–‡ä»¶ï¼ˆä½Žèµ„æºæ¶ˆè€—ï¼‰
          cat > deploy-package/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'uptime-kuma',
    script: 'server/server.js',
    instances: 1,
    exec_mode: 'fork',

    // å†…å­˜é™åˆ¶
    max_memory_restart: '150M',

    // Node.js å‚æ•°
    node_args: '--max-old-space-size=128',

    // çŽ¯å¢ƒå˜é‡
    env: {
      NODE_ENV: 'production',
      UPTIME_KUMA_LOG_LEVEL: 'warn'
    },

    // æ—¥å¿—é…ç½®ï¼ˆé™åˆ¶å¤§å°ï¼‰
    error_file: 'logs/error.log',
    out_file: 'logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true,

    // è‡ªåŠ¨é‡å¯é…ç½®
    autorestart: true,
    watch: false,
    max_restarts: 10,
    min_uptime: '10s',

    // ä¼˜é›…å…³é—­
    kill_timeout: 5000,
    wait_ready: true,
    listen_timeout: 10000
  }]
};
EOF

          # åˆ›å»º systemd æœåŠ¡æ–‡ä»¶
          cat > deploy-package/uptime-kuma.service << 'EOF'
[Unit]
Description=Uptime Kuma - Optimized for Low-End Server
After=network.target

[Service]
Type=simple
User=YOUR_USERNAME
WorkingDirectory=/path/to/uptime-kuma
Environment="NODE_ENV=production"
Environment="NODE_OPTIONS=--max-old-space-size=128"
Environment="UPTIME_KUMA_LOG_LEVEL=warn"
ExecStart=/usr/bin/node server/server.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=uptime-kuma

# èµ„æºé™åˆ¶
MemoryLimit=200M
CPUQuota=50%

[Install]
WantedBy=multi-user.target
EOF

          # åˆ›å»ºä¼˜åŒ–é…ç½®è¯´æ˜Ž
          cat > deploy-package/OPTIMIZATION.md << 'EOF'
# ðŸš€ ä½Žé…æœåŠ¡å™¨ä¼˜åŒ–é…ç½®

æœ¬ç‰ˆæœ¬å·²é’ˆå¯¹ä½Žé…æœåŠ¡å™¨è¿›è¡Œä¼˜åŒ–ï¼š

## âœ… å·²åº”ç”¨çš„ä¼˜åŒ–

1. **ä»…ç”Ÿäº§ä¾èµ–** - å‡å°‘ ~150MB ç£ç›˜å ç”¨
2. **é™åˆ¶å†…å­˜** - æœ€å¤§ 128MB Node.js å †å†…å­˜
3. **å‡å°‘æ—¥å¿—** - ä»…è¾“å‡ºè­¦å‘Šå’Œé”™è¯¯
4. **é¢„æž„å»ºå‰ç«¯** - æ— éœ€æœ¬åœ°æž„å»ºï¼ŒèŠ‚çœèµ„æº

## ðŸ“Š é¢„æœŸèµ„æºæ¶ˆè€—

- **å†…å­˜**: ~80-120 MB
- **ç£ç›˜**: ~400 MB
- **CPU**: ç©ºé—²æ—¶ <1%

## ðŸ”§ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ 1: ä½¿ç”¨ PM2ï¼ˆæŽ¨èï¼‰

```bash
npm install pm2 -g
pm2 start ecosystem.config.js
pm2 startup
pm2 save
```

### æ–¹å¼ 2: ä½¿ç”¨ systemd

```bash
# ç¼–è¾‘æœåŠ¡æ–‡ä»¶ï¼Œä¿®æ”¹ç”¨æˆ·åå’Œè·¯å¾„
sudo nano uptime-kuma.service

# å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•
sudo cp uptime-kuma.service /etc/systemd/system/

# å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl start uptime-kuma
sudo systemctl enable uptime-kuma
```

### æ–¹å¼ 3: ç›´æŽ¥è¿è¡Œ

```bash
./start-optimized.sh
```

## âš™ï¸ é¢å¤–ä¼˜åŒ–å»ºè®®

1. **å‡å°‘ç›‘æŽ§é¢‘çŽ‡**
   - åœ¨ Web ç•Œé¢ä¸­ï¼Œå°†ç›‘æŽ§é—´éš”è®¾ç½®ä¸º 120 ç§’æˆ–æ›´é•¿

2. **é™åˆ¶ç›‘æŽ§æ•°é‡**
   - å»ºè®®ä¸è¶…è¿‡ 20 ä¸ªç›‘æŽ§é¡¹ç›®

3. **ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½**
   - å…³é—­ä¸éœ€è¦çš„é€šçŸ¥æ¸ é“
   - ç¦ç”¨ Docker ç›‘æŽ§ï¼ˆå¦‚æžœä¸éœ€è¦ï¼‰

4. **å®šæœŸæ¸…ç†**
   ```bash
   # æ¸…ç†æ—§æ•°æ®ï¼ˆä¿ç•™ 30 å¤©ï¼‰
   sqlite3 data/kuma.db "DELETE FROM heartbeat WHERE time < datetime('now', '-30 days');"
   sqlite3 data/kuma.db "VACUUM;"
   ```

## ðŸ” ç›‘æŽ§èµ„æºä½¿ç”¨

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
ps aux | grep node

# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs uptime-kuma --lines 50
```
EOF

          # æ‰“åŒ…
          tar -czf uptime-kuma-optimized.tar.gz -C deploy-package .

          echo "âœ… ä¼˜åŒ–éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"
          ls -lh uptime-kuma-optimized.tar.gz

      - name: Generate release notes
        if: steps.check_updates.outputs.has_updates == 'true'
        id: release_notes
        run: |
          UPSTREAM_VERSION="${{ steps.check_updates.outputs.upstream_version }}"
          CURRENT_VERSION="${{ steps.check_updates.outputs.current_version }}"

          cat > release_notes.md << EOF
          # ðŸŽ‰ è‡ªåŠ¨æ›´æ–°è‡³ ${UPSTREAM_VERSION}

          ## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯

          - **ä¸Šæ¸¸ç‰ˆæœ¬**: ${UPSTREAM_VERSION}
          - **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **æ›´æ–°æ–¹å¼**: è‡ªåŠ¨æ£€æµ‹å¹¶åˆå¹¶

          ## âš¡ ä¼˜åŒ–ç‰¹æ€§

          æœ¬ç‰ˆæœ¬å·²é’ˆå¯¹ä½Žé…æœåŠ¡å™¨è¿›è¡Œæ·±åº¦ä¼˜åŒ–ï¼š

          - âœ… **ä»…ç”Ÿäº§ä¾èµ–** - å‡å°‘çº¦ 150MB ç£ç›˜å ç”¨
          - âœ… **å†…å­˜é™åˆ¶** - Node.js å †å†…å­˜é™åˆ¶ä¸º 128MB
          - âœ… **æ—¥å¿—ä¼˜åŒ–** - ä»…è¾“å‡ºè­¦å‘Šå’Œé”™è¯¯çº§åˆ«æ—¥å¿—
          - âœ… **é¢„æž„å»ºå‰ç«¯** - æ— éœ€æœ¬åœ°æž„å»ºï¼ŒèŠ‚çœ CPU å’Œæ—¶é—´
          - âœ… **èµ„æºé™åˆ¶** - systemd é…ç½®åŒ…å«å†…å­˜å’Œ CPU é™åˆ¶

          ## ðŸ“Š é¢„æœŸèµ„æºæ¶ˆè€—

          - **å†…å­˜**: ~80-120 MBï¼ˆæ¯”æ ‡å‡†ç‰ˆæœ¬èŠ‚çœ 30-50%ï¼‰
          - **ç£ç›˜**: ~400 MBï¼ˆæ¯”æ ‡å‡†ç‰ˆæœ¬èŠ‚çœ 35%ï¼‰
          - **CPU**: ç©ºé—²æ—¶ <1%

          ## ðŸš€ å¿«é€Ÿéƒ¨ç½²

          ### ä¸‹è½½å¹¶è§£åŽ‹

          \`\`\`bash
          wget https://github.com/YOUR_USERNAME/uptime-kuma/releases/download/${UPSTREAM_VERSION}/uptime-kuma-optimized.tar.gz
          tar -xzf uptime-kuma-optimized.tar.gz
          cd uptime-kuma
          \`\`\`

          ### ä½¿ç”¨ PM2 å¯åŠ¨ï¼ˆæŽ¨èï¼‰

          \`\`\`bash
          npm install pm2 -g
          pm2 start ecosystem.config.js
          pm2 startup && pm2 save
          \`\`\`

          ### æˆ–ä½¿ç”¨ systemd

          \`\`\`bash
          # ç¼–è¾‘ uptime-kuma.serviceï¼Œä¿®æ”¹ç”¨æˆ·åå’Œè·¯å¾„
          sudo cp uptime-kuma.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl start uptime-kuma
          sudo systemctl enable uptime-kuma
          \`\`\`

          ## ðŸ“ ä¸Šæ¸¸æ›´æ–°æ—¥å¿—

          æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—: https://github.com/louislam/uptime-kuma/releases/tag/${UPSTREAM_VERSION}

          ## âš ï¸ æ³¨æ„äº‹é¡¹

          1. é¦–æ¬¡éƒ¨ç½²éœ€è¦åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://your-server:3001 å®Œæˆåˆå§‹è®¾ç½®
          2. å»ºè®®å°†ç›‘æŽ§é—´éš”è®¾ç½®ä¸º 120 ç§’æˆ–æ›´é•¿ä»¥èŠ‚çœèµ„æº
          3. å»ºè®®ç›‘æŽ§é¡¹ç›®æ•°é‡ä¸è¶…è¿‡ 20 ä¸ª
          4. å®šæœŸæ¸…ç†æ—§æ•°æ®ä»¥ä¿æŒæ•°æ®åº“ç²¾ç®€

          ---

          ðŸ¤– æœ¬ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ
          EOF

          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          UPSTREAM_VERSION="${{ steps.check_updates.outputs.upstream_version }}"

          git add .
          git commit -m "feat: è‡ªåŠ¨æ›´æ–°è‡³ ${UPSTREAM_VERSION} å¹¶ä¼˜åŒ–ä½Žé…æœåŠ¡å™¨æ€§èƒ½

- åˆå¹¶ä¸Šæ¸¸ ${UPSTREAM_VERSION} ç‰ˆæœ¬æ›´æ–°
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼ˆé™åˆ¶ 128MB å †å†…å­˜ï¼‰
- ä»…å®‰è£…ç”Ÿäº§ä¾èµ–ï¼Œå‡å°‘ç£ç›˜å ç”¨
- æ·»åŠ ä½Žé…æœåŠ¡å™¨ä¼˜åŒ–é…ç½®
- åŒ…å« PM2 å’Œ systemd é…ç½®æ–‡ä»¶
- é¢„æœŸå†…å­˜æ¶ˆè€—: ~80-120MB
- é¢„æœŸç£ç›˜å ç”¨: ~400MB

ðŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"

          git push origin master

      - name: Create GitHub Release
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_updates.outputs.upstream_version }}
          name: "ðŸš€ ä¼˜åŒ–ç‰ˆæœ¬ ${{ steps.check_updates.outputs.upstream_version }}"
          body: ${{ steps.release_notes.outputs.release_notes }}
          files: uptime-kuma-optimized.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "## ðŸŽ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.check_updates.outputs.upstream_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¼˜åŒ–åŒ…**: uptime-kuma-optimized.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **å†…å­˜æ¶ˆè€—**: ~80-120 MB" >> $GITHUB_STEP_SUMMARY
          echo "- **ç£ç›˜å ç”¨**: ~400 MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/${{ steps.check_updates.outputs.upstream_version }}" >> $GITHUB_STEP_SUMMARY
